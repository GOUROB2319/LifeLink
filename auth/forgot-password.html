<!DOCTYPE html>
<html class="theme-preload" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - LifeLink</title>
    <script src="../assets/js/theme-manager.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/components.js"></script>
    <link href="../assets/css/styles.css" rel="stylesheet" />
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg" />
</head>

<body
    class="bg-aurora text-slate-800 dark:text-slate-100 antialiased selection:bg-primary/30 selection:text-primary-dark transition-colors duration-500 overflow-x-hidden">
    <app-navbar></app-navbar>

    <main class="relative z-10 pt-32 pb-12 min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8">
        <div
            class="max-w-md w-full bg-white dark:bg-surface-dark rounded-[2rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-700 animate-fade-in p-8 lg:p-12">

            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <span class="material-symbols-outlined text-primary text-3xl">lock_reset</span>
                </div>
                <h2 class="text-3xl font-black text-slate-900 dark:text-white mb-2">Reset Password</h2>
                <p class="text-slate-500 text-sm" id="stepDesc">Enter your email, we'll send a verification code</p>
            </div>

            <!-- Success Message -->
            <div id="successMsg" class="hidden mb-6 p-4 rounded-xl bg-primary/10 border border-primary/20 text-primary">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-2xl">check_circle</span>
                    <div>
                        <p class="font-bold mb-1">Password Changed Successfully!</p>
                        <p class="text-sm">Now login with your new password.</p>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMsg"
                class="hidden mb-6 p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900/30 text-red-600 dark:text-red-400">
                <div class="flex items-start gap-3">
                    <span class="material-symbols-outlined text-2xl">error</span>
                    <p class="text-sm font-medium" id="errorText">Something went wrong</p>
                </div>
            </div>

            <!-- Step 1: Email -->
            <form id="emailForm" class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Email
                        Address</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">mail</span>
                        <input type="email" id="email" required
                            class="w-full pl-12 pr-4 py-3.5 bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-xl focus:border-primary focus:ring-0 transition-all outline-none font-medium"
                            placeholder="your@email.com">
                    </div>
                </div>

                <button type="submit" id="sendCodeBtn"
                    class="w-full bg-brand-gradient text-white py-4 rounded-xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-2">
                    <span>Send Verification Code</span>
                    <span class="material-symbols-outlined">send</span>
                </button>
            </form>

            <!-- Step 2: Verify Code -->
            <form id="verifyForm" class="space-y-5 hidden">
                <div
                    class="p-4 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 mb-4">
                    <p class="text-sm text-blue-700 dark:text-blue-300">📧 Check your email and enter the 6-digit code
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Verification
                        Code</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">pin</span>
                        <input type="text" id="code" required maxlength="6" pattern="[0-9]{6}"
                            class="w-full pl-12 pr-4 py-3.5 bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-xl focus:border-primary focus:ring-0 transition-all outline-none font-medium text-center text-2xl tracking-widest"
                            placeholder="000000">
                    </div>
                </div>

                <button type="submit" id="verifyBtn"
                    class="w-full bg-brand-gradient text-white py-4 rounded-xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-2">
                    <span>Verify Code</span>
                    <span class="material-symbols-outlined">verified</span>
                </button>

                <button type="button" id="resendBtn" class="w-full text-primary font-bold text-sm hover:underline">
                    Resend Code
                </button>
            </form>

            <!-- Step 3: New Password -->
            <form id="passwordForm" class="space-y-5 hidden">
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">New
                        Password</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">lock</span>
                        <input type="password" id="newPassword" required minlength="6"
                            class="w-full pl-12 pr-4 py-3.5 bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-xl focus:border-primary focus:ring-0 transition-all outline-none font-medium"
                            placeholder="••••••••">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2">Confirm
                        Password</label>
                    <div class="relative">
                        <span
                            class="material-symbols-outlined absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">lock</span>
                        <input type="password" id="confirmPassword" required minlength="6"
                            class="w-full pl-12 pr-4 py-3.5 bg-slate-50 dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-700 rounded-xl focus:border-primary focus:ring-0 transition-all outline-none font-medium"
                            placeholder="••••••••">
                    </div>
                </div>

                <button type="submit" id="resetPasswordBtn"
                    class="w-full bg-brand-gradient text-white py-4 rounded-xl font-bold shadow-lg shadow-primary/20 hover:scale-[1.02] active:scale-[0.98] transition-all duration-300 flex items-center justify-center gap-2">
                    <span>Change Password</span>
                    <span class="material-symbols-outlined">check_circle</span>
                </button>
            </form>

            <div class="mt-6 text-center">
                <a href="login.html"
                    class="text-sm text-primary font-bold hover:underline flex items-center justify-center gap-1">
                    <span class="material-symbols-outlined text-lg">arrow_back</span>
                    <span>Back to Login</span>
                </a>
            </div>
        </div>
    </main>

    <app-footer></app-footer>
    <script type="module">
        import { sendPasswordResetWithCode, verifyResetCode, confirmPasswordReset } from '../assets/js/auth-service.js';
        import { validateField, showFieldError, clearFieldError } from '../assets/js/validation.js';

        const emailForm = document.getElementById('emailForm');
        const verifyForm = document.getElementById('verifyForm');
        const passwordForm = document.getElementById('passwordForm');
        const emailInput = document.getElementById('email');
        const codeInput = document.getElementById('code');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const successMsg = document.getElementById('successMsg');
        const errorMsg = document.getElementById('errorMsg');
        const errorText = document.getElementById('errorText');
        const stepDesc = document.getElementById('stepDesc');

        let userEmail = '';
        let actionCode = '';

        function showError(msg) {
            errorMsg.classList.remove('hidden');
            errorText.textContent = msg;
            setTimeout(() => errorMsg.classList.add('hidden'), 5000);
        }

        // Step 1: Send Code
        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');
            clearFieldError(emailInput);

            const email = emailInput.value.trim();
            const emailError = validateField('email', email);
            if (emailError) {
                showFieldError(emailInput, emailError);
                return;
            }

            const btn = document.getElementById('sendCodeBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> <span>Sending...</span>';

            const result = await sendPasswordResetWithCode(email);

            btn.disabled = false;
            btn.innerHTML = originalText;

            if (result.success) {
                userEmail = email;
                emailForm.classList.add('hidden');
                verifyForm.classList.remove('hidden');
                stepDesc.textContent = 'Enter the code sent to your email';
            } else {
                if (result.error?.code === 'auth/user-not-found') {
                    showError('No account exists with this email.');
                } else {
                    showError(result.error?.message || 'Failed to send code.');
                }
            }
        });

        // Step 2: Verify Code
        verifyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');

            const code = codeInput.value.trim();
            if (code.length !== 6) {
                showError('Enter the 6-digit code');
                return;
            }

            const btn = document.getElementById('verifyBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> <span>Verifying...</span>';

            const result = await verifyResetCode(code);

            btn.disabled = false;
            btn.innerHTML = originalText;

            if (result.success) {
                actionCode = code;
                verifyForm.classList.add('hidden');
                passwordForm.classList.remove('hidden');
                stepDesc.textContent = 'Set your new password';
            } else {
                showError('Invalid or expired code. Please try again.');
            }
        });

        // Resend Code
        document.getElementById('resendBtn').addEventListener('click', async () => {
            const result = await sendPasswordResetWithCode(userEmail);
            if (result.success) {
                showError('New code sent!');
            }
        });

        // Step 3: Reset Password
        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMsg.classList.add('hidden');

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (newPassword.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            const btn = document.getElementById('resetPasswordBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="material-symbols-outlined animate-spin">progress_activity</span> <span>Changing...</span>';

            const result = await confirmPasswordReset(actionCode, newPassword);

            btn.disabled = false;
            btn.innerHTML = originalText;

            if (result.success) {
                passwordForm.classList.add('hidden');
                successMsg.classList.remove('hidden');
                setTimeout(() => window.location.href = 'login.html', 2000);
            } else {
                showError('Failed to change password.');
            }
        });
    </script>
</body>

</html>