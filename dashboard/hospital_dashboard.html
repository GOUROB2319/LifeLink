<!DOCTYPE html>
<html class="theme-preload" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Dashboard - LifeLink</title>
    <script src="../assets/js/theme-manager.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&amp;display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/components.js"></script>
    <link href="../assets/css/styles.css" rel="stylesheet" />
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg" />
</head>

<body
    class="bg-aurora text-slate-800 dark:text-slate-100 antialiased selection:bg-primary/30 selection:text-primary-dark transition-colors duration-500 overflow-x-hidden">
    <app-navbar auth="true"></app-navbar>
    <main class="relative z-10 pt-28 pb-20 min-h-screen">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-10">
                <div>
                    <h1 class="text-4xl font-black text-slate-900 dark:text-white mb-2">Hospital Dashboard</h1>
                    <p class="text-slate-600 dark:text-slate-400">Manage requests, donors, and inventory updates</p>
                </div>
                <div class="flex gap-3">
                    <a href="emergency.html"
                        class="px-6 py-3 rounded-xl bg-emergency text-white font-semibold shadow-lg shadow-red-500/20 hover:scale-105 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined">e911_emergency</span>
                        <span>New Request</span>
                    </a>
                    <a id="hospitalProfileLink" href="hospital.html"
                        class="px-6 py-3 rounded-xl border-2 border-slate-300 dark:border-slate-600 font-semibold hover:bg-slate-50 dark:hover:bg-slate-800 transition-all flex items-center gap-2">
                        <span class="material-symbols-outlined">apartment</span>
                        <span>View Profile</span>
                    </a>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <div
                    class="bg-white dark:bg-surface-dark rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                    <p class="text-sm text-slate-500 mb-2">Active Requests</p>
                    <p id="activeCount" class="text-4xl font-black text-slate-900 dark:text-white">0</p>
                    <p class="text-xs text-slate-500 mt-2">Open and in-progress</p>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-indigo-500 rounded-2xl p-6 text-white shadow-lg">
                    <p class="text-sm opacity-90 mb-2">Total Requests</p>
                    <p id="totalCount" class="text-4xl font-black mb-1">0</p>
                    <p class="text-sm opacity-75">All time</p>
                </div>
                <div class="bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-2xl p-6 text-white shadow-lg">
                    <p class="text-sm opacity-90 mb-2">Matched Donors</p>
                    <p id="matchedCount" class="text-4xl font-black mb-1">0</p>
                    <p class="text-sm opacity-75">Confirmed donors</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div
                    class="bg-white dark:bg-surface-dark rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">list_alt</span>
                        Recent Requests
                    </h3>
                    <div id="requestsList" class="space-y-4">
                        <div class="text-center py-10">
                            <div
                                class="w-10 h-10 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto mb-4">
                            </div>
                            <p class="text-slate-500">Loading requests...</p>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-surface-dark rounded-2xl p-6 shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-symbols-outlined text-primary">warehouse</span>
                        Inventory Notes
                    </h3>
                    <div class="space-y-4">
                        <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-800">
                            <p class="text-sm text-slate-600 dark:text-slate-400">Keep inventory updated to improve
                                donor matching speed.</p>
                        </div>
                        <textarea id="inventoryNotes" rows="6"
                            class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                            placeholder="Add internal notes about blood inventory or staffing..."></textarea>
                        <div class="grid grid-cols-2 gap-4">
                            <input id="bloodType" placeholder="Blood Type (e.g., O+)"
                                class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" />
                            <input id="bloodUnits" type="number" min="0" placeholder="Units"
                                class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all" />
                        </div>
                        <div class="overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50 dark:bg-slate-800/60 text-slate-500">
                                    <tr>
                                        <th class="text-left px-4 py-3 font-semibold">Blood Type</th>
                                        <th class="text-left px-4 py-3 font-semibold">Units</th>
                                        <th class="text-right px-4 py-3 font-semibold">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTable" class="divide-y divide-slate-100 dark:divide-slate-800">
                                    <tr>
                                        <td colspan="3" class="px-4 py-4 text-slate-500">No inventory updates yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <button id="saveNotes"
                            class="w-full bg-brand-gradient text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-primary/20 hover:scale-105 transition-all">
                            Save Notes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { auth, db, initAuthObserver } from '../assets/js/auth-service.js';
        import { getFullUserProfile, updateRequestStatus, saveHospitalInventory, collection, query, where, orderBy, onSnapshot } from '../assets/js/db-service.js';

        localStorage.setItem('lifelink_dashboard', 'hospital_dashboard.html');

        const requestsList = document.getElementById('requestsList');
        const activeCount = document.getElementById('activeCount');
        const totalCount = document.getElementById('totalCount');
        const matchedCount = document.getElementById('matchedCount');
        const inventoryNotes = document.getElementById('inventoryNotes');
        const saveNotesBtn = document.getElementById('saveNotes');
        const hospitalProfileLink = document.getElementById('hospitalProfileLink');
        const bloodTypeInput = document.getElementById('bloodType');
        const bloodUnitsInput = document.getElementById('bloodUnits');
        const inventoryTable = document.getElementById('inventoryTable');

        let bloodAvailability = {};

        const fallbackAfter = (container, message, delay = 6000) => {
            setTimeout(() => {
                if (container && container.textContent.includes('Loading')) {
                    container.innerHTML = `<p class="text-sm text-slate-500">${message}</p>`;
                }
            }, delay);
        };

        initAuthObserver(async (user) => {
            const navbar = document.querySelector('app-navbar');
            if (user && navbar && navbar.updateAuth) navbar.updateAuth(user);

            if (!user) {
                window.location.href = '../auth/login.html';
                return;
            }

            const profile = await getFullUserProfile(db, user.uid);
            if (profile) {
                if (profile.inventoryNotes) inventoryNotes.value = profile.inventoryNotes;
                if (profile.bloodAvailability) bloodAvailability = profile.bloodAvailability;
                hospitalProfileLink.href = `hospital.html?uid=${user.uid}`;
                renderInventoryTable();
            }

            fallbackAfter(requestsList, 'No requests submitted yet.');
            listenForRequests(user.uid);
        });

        function listenForRequests(uid) {
            const reqRef = collection(db, 'requests');
            const q = query(reqRef, where('userId', '==', uid), orderBy('createdAt', 'desc'));

            onSnapshot(q, (snap) => {
                if (snap.empty) {
                    requestsList.innerHTML = '<p class="text-sm text-slate-500">No requests submitted yet.</p>';
                    activeCount.textContent = '0';
                    totalCount.textContent = '0';
                    matchedCount.textContent = '0';
                    return;
                }

                const items = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const active = items.filter(item => item.status === 'active');
                const matched = items.filter(item => item.status === 'matched');

                activeCount.textContent = active.length;
                totalCount.textContent = items.length;
                matchedCount.textContent = matched.length;

                requestsList.innerHTML = items.slice(0, 6).map(item => `
                    <div class="flex items-center gap-4 p-4 rounded-xl bg-slate-50 dark:bg-slate-800">
                        <div class="w-12 h-12 rounded-full bg-emergency/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-emergency">bloodtype</span>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-slate-900 dark:text-white">${item.bloodGroup || 'Blood'} Request</p>
                            <p class="text-sm text-slate-600 dark:text-slate-400">${item.district || 'District'} · ${item.urgency || 'Normal'}</p>
                            <p class="text-xs text-slate-500 mt-1">Status: <span class="font-semibold">${item.status || 'submitted'}</span></p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-slate-500 mb-2">${formatDate(item.createdAt)}</p>
                            <div class="flex gap-2">
                                <button data-id="${item.id}" data-status="matched" class="status-btn text-xs font-bold text-emerald-600 hover:underline">Match</button>
                                <button data-id="${item.id}" data-status="completed" class="status-btn text-xs font-bold text-primary hover:underline">Complete</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                const statusButtons = requestsList.querySelectorAll('.status-btn');
                statusButtons.forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const id = btn.getAttribute('data-id');
                        const status = btn.getAttribute('data-status');
                        const res = await updateRequestStatus(db, id, status);
                        if (!res.success) {
                            alert('Unable to update: ' + res.error);
                        }
                    });
                });
            });
        }

        saveNotesBtn.addEventListener('click', async () => {
            saveNotesBtn.disabled = true;
            saveNotesBtn.textContent = 'Saving...';

            const bloodType = bloodTypeInput.value.trim();
            const units = parseInt(bloodUnitsInput.value, 10);
            if (bloodType) {
                bloodAvailability[bloodType] = Number.isFinite(units) ? units : 0;
            }

            const result = await saveHospitalInventory(db, auth.currentUser.uid, {
                inventoryNotes: inventoryNotes.value,
                bloodAvailability
            });

            if (result.success) {
                renderInventoryTable();
                saveNotesBtn.textContent = 'Saved';
                setTimeout(() => {
                    saveNotesBtn.textContent = 'Save Notes';
                    saveNotesBtn.disabled = false;
                }, 1500);
            } else {
                alert('Error saving notes: ' + result.error);
                saveNotesBtn.textContent = 'Save Notes';
                saveNotesBtn.disabled = false;
            }
        });

        function formatDate(value) {
            if (!value) return '—';
            const date = value.toDate ? value.toDate() : new Date(value);
            return date.toLocaleDateString();
        }

        function renderInventoryTable() {
            const entries = Object.entries(bloodAvailability || {});
            if (!entries.length) {
                inventoryTable.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-slate-500">No inventory updates yet.</td></tr>';
                return;
            }

            inventoryTable.innerHTML = entries.map(([type, units]) => `
                <tr>
                    <td class="px-4 py-3 font-semibold text-slate-900 dark:text-white">${type}</td>
                    <td class="px-4 py-3 text-slate-600 dark:text-slate-400">${units}</td>
                    <td class="px-4 py-3 text-right">
                        <button data-type="${type}" class="remove-inventory text-xs font-bold text-emergency hover:underline">Remove</button>
                    </td>
                </tr>
            `).join('');

            const removeButtons = inventoryTable.querySelectorAll('.remove-inventory');
            removeButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const type = btn.getAttribute('data-type');
                    delete bloodAvailability[type];
                    await saveHospitalInventory(db, auth.currentUser.uid, {
                        inventoryNotes: inventoryNotes.value,
                        bloodAvailability
                    });
                    renderInventoryTable();
                });
            });
        }
    </script></body>

</html>