<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>St. Mary's General Hospital - LifeLink</title>    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1a57db",
                        "background-light": "#f6f6f8",
                        "background-dark": "#111621",
                        "emergency": "#DC2626",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "0.75rem", // Mapped 12px roughly to xl for this specific request context or explicit class
                        "2xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom class for exact 12px radius as requested */
        .rounded-card {
            border-radius: 12px;
        }
    </style>
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg" />
    <link rel="apple-touch-icon" href="../assets/images/favicon.svg" />
    <script src="../assets/js/components.js"></script>
</head>

<body
    class="bg-aurora text-slate-800 antialiased selection:bg-primary/30 selection:text-primary-dark transition-colors duration-500 overflow-x-hidden">
    <div class="flex min-h-screen flex-col">
        <!-- Top Navigation -->
        <app-navbar></app-navbar>
        <!-- Main Content -->
        <main class="flex-1 px-4 py-8 lg:px-8">
            <div class="mx-auto max-w-[1200px]">
                <!-- Breadcrumbs -->
                <nav class="mb-6 flex items-center text-sm text-[#636e88]">
                    <a class="hover:text-primary" href="../index.html">Home</a>
                    <span class="mx-2">/</span>
                    <a class="hover:text-primary" href="directory.html">Directory</a>
                    <span class="mx-2">/</span>
                    <span class="font-medium text-[#111318]">St. Mary's General Hospital</span>
                </nav>
                <!-- Hero Header -->
                <div class="rounded-card mb-6 overflow-hidden bg-white shadow-sm">
                    <div class="h-48 w-full bg-cover bg-center md:h-64"
                        data-alt="Modern hospital building exterior with glass facade"
                        style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAeEUtiOVSJ5ww_p6DuMPddQum7PHUCtm1zcbaFZzgockgSwtIONf5NVP7LtFc6EaGEyHgBVS5njA-NuUnDmiTl3hWOcMTPzVubg_YdFrdYYWkUaIXBjPNVgsTdIII_cT2-hloV10Uqn0nzcsvDe75waLs4FyCmOqqhVEbTR_1TE3zVwfGVs9P1n1S2BofDQ7w2Glw-p4vh8Cu9Tvd4lTjAKkNzJsOH2LPxoQaB2vimVjhnxj78bOs7SazsPfQ8NwS95nISNl09pN2L");'>
                        <div class="h-full w-full bg-gradient-to-t from-black/60 to-transparent"></div>
                    </div>
                    <div class="flex flex-col gap-6 px-6 py-6 md:flex-row md:items-start md:justify-between">
                        <div class="flex flex-col gap-2">
                            <div class="flex items-center gap-3">
                                <h1
                                    class="text-3xl font-black tracking-tight text-[#111318] md:text-4xl">
                                    St. Mary's General Hospital</h1>
                                <span
                                    class="flex items-center gap-1 rounded-full bg-blue-100 px-3 py-1 text-xs font-bold text-primary">
                                    <span class="material-symbols-outlined text-[16px]">verified</span>
                                    Verified
                                </span>
                            </div>
                            <div class="flex flex-wrap items-center gap-4 text-sm text-[#636e88]">
                                <div class="flex items-center gap-1">
                                    <span
                                        class="material-symbols-outlined text-yellow-400 text-[18px] fill-1">star</span>
                                    <span class="font-bold text-[#111318]">4.8</span>
                                    <span>(500+ reviews)</span>
                                </div>
                                <span class="hidden md:inline">•</span>
                                <div class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-[18px]">location_on</span>
                                    123 Healthcare Blvd, Medical District
                                </div>
                                <span class="hidden md:inline">•</span>
                                <div class="flex items-center gap-1 text-green-600">
                                    <span class="material-symbols-outlined text-[18px]">schedule</span>
                                    Open 24 Hours
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3 md:min-w-[400px] md:justify-end">
                            <button
                                class="rounded-card flex flex-1 items-center justify-center gap-2 bg-primary px-6 py-3 text-base font-bold text-white transition hover:bg-blue-700 md:flex-none">
                                <span class="material-symbols-outlined text-[20px]">calendar_month</span>
                                Schedule Appointment
                            </button>
                            <button
                                class="rounded-card flex flex-1 items-center justify-center gap-2 border border-emergency bg-white px-6 py-3 text-base font-bold text-emergency transition hover:bg-red-50 md:flex-none">
                                <span class="material-symbols-outlined text-[20px] fill-1">emergency</span>
                                Contact Emergency Wing
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Main Grid Layout -->
                <div class="grid grid-cols-1 gap-6 lg:grid-cols-12">
                    <!-- Left Column (Content) -->
                    <div class="flex flex-col gap-6 lg:col-span-8">
                        <!-- Blood Availability Dashboard -->
                        <section class="rounded-card bg-white p-6 shadow-sm">
                            <div class="mb-5 flex items-center justify-between">
                                <h3 class="flex items-center gap-2 text-lg font-bold text-[#111318]">
                                    <span class="material-symbols-outlined text-red-500">bloodtype</span>
                                    Available Blood Units
                                </h3>
                                <span class="text-xs text-[#636e88]">Updated: 15 mins ago</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                                <!-- Card 1 -->
                                <div
                                    class="rounded-card border border-gray-100 bg-gray-50 p-4 text-center">
                                    <div class="mb-1 text-2xl font-black text-[#111318]">A+</div>
                                    <div class="text-sm font-medium text-green-600">12 Units</div>
                                    <div class="mt-1 h-1.5 w-full rounded-full bg-gray-200">
                                        <div class="h-1.5 rounded-full bg-green-500" style="width: 80%"></div>
                                    </div>
                                </div>
                                <!-- Card 2 -->
                                <div
                                    class="rounded-card border border-red-100 bg-red-50 p-4 text-center">
                                    <div class="mb-1 text-2xl font-black text-emergency">O-</div>
                                    <div class="text-sm font-bold text-emergency">2 Units</div>
                                    <div class="mt-1 h-1.5 w-full rounded-full bg-gray-200">
                                        <div class="h-1.5 rounded-full bg-emergency" style="width: 20%"></div>
                                    </div>
                                    <span
                                        class="mt-1 block text-[10px] font-bold uppercase tracking-wider text-emergency">Critical</span>
                                </div>
                                <!-- Card 3 -->
                                <div
                                    class="rounded-card border border-gray-100 bg-gray-50 p-4 text-center">
                                    <div class="mb-1 text-2xl font-black text-[#111318]">AB+</div>
                                    <div class="text-sm font-medium text-green-600">8 Units</div>
                                    <div class="mt-1 h-1.5 w-full rounded-full bg-gray-200">
                                        <div class="h-1.5 rounded-full bg-green-500" style="width: 60%"></div>
                                    </div>
                                </div>
                                <!-- Card 4 -->
                                <div
                                    class="rounded-card border border-gray-100 bg-gray-50 p-4 text-center">
                                    <div class="mb-1 text-2xl font-black text-[#111318]">B+</div>
                                    <div class="text-sm font-medium text-yellow-600">4 Units</div>
                                    <div class="mt-1 h-1.5 w-full rounded-full bg-gray-200">
                                        <div class="h-1.5 rounded-full bg-yellow-500" style="width: 40%"></div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <!-- Specialties -->
                        <section class="rounded-card bg-white p-6 shadow-sm">
                            <h3 class="mb-4 text-lg font-bold text-[#111318]">Medical Specialties</h3>
                            <div class="flex flex-wrap gap-3">
                                <span
                                    class="rounded-card inline-flex items-center gap-2 bg-blue-50 px-4 py-2 text-sm font-semibold text-primary">
                                    <span class="material-symbols-outlined text-[18px]">cardiology</span> Cardiology
                                </span>
                                <span
                                    class="rounded-card inline-flex items-center gap-2 bg-blue-50 px-4 py-2 text-sm font-semibold text-primary">
                                    <span class="material-symbols-outlined text-[18px]">neurology</span> Neurology
                                </span>
                                <span
                                    class="rounded-card inline-flex items-center gap-2 bg-blue-50 px-4 py-2 text-sm font-semibold text-primary">
                                    <span class="material-symbols-outlined text-[18px]">child_care</span> Pediatrics
                                </span>
                                <span
                                    class="rounded-card inline-flex items-center gap-2 bg-blue-50 px-4 py-2 text-sm font-semibold text-primary">
                                    <span class="material-symbols-outlined text-[18px]">medical_services</span> General
                                    Surgery
                                </span>
                                <span
                                    class="rounded-card inline-flex items-center gap-2 bg-blue-50 px-4 py-2 text-sm font-semibold text-primary">
                                    <span class="material-symbols-outlined text-[18px]">radiology</span> Oncology
                                </span>
                                <span
                                    class="rounded-card inline-flex items-center gap-2 bg-red-50 px-4 py-2 text-sm font-semibold text-red-700">
                                    <span class="material-symbols-outlined text-[18px]">emergency</span> Level 1 Trauma
                                    Center
                                </span>
                            </div>
                        </section>
                        <!-- Doctor Directory -->
                        <section class="rounded-card bg-white p-6 shadow-sm">
                            <div class="mb-4 flex items-center justify-between">
                                <h3 class="text-lg font-bold text-[#111318]">Doctor Directory</h3>
                                <a class="text-sm font-semibold text-primary hover:underline" href="directory.html">View
                                    all</a>
                            </div>
                            <div class="grid gap-4 md:grid-cols-2">
                                <!-- Doctor Card 1 -->
                                <div
                                    class="rounded-card flex items-start gap-4 border border-[#f0f2f4] p-4 transition hover:border-blue-100 hover:bg-blue-50/30">
                                    <div class="h-16 w-16 shrink-0 overflow-hidden rounded-full bg-gray-200">
                                        <img alt="Dr. Sarah Jennings profile picture" class="h-full w-full object-cover"
                                            width="64" height="64" loading="lazy" decoding="async"
                                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuCso3TNnQrbJzUbMOcAzJBwCc_G7wL8GBEnZfKn-aA_fXdShwUFQ7ZmZt6UjHi4IRkUtTIs9chfo76MZVHIsH6Rua8eETQ8tBt-WGIcwweuvALLC6u-iIXpgja8wTgC5l5MQEFXUq8YdqG5VURsYORkuoLHn1DhlWd5YVwSRVWA0xQqaQF0lJi9QRkI8B7j5p4qdv7-V5q20efyeJyqvoDHj0NuUVNRyk9JwwKl7cVbjPVSIagIVfmAnvRg0IaOzQ74S9IoWdj5xq8E" />
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-bold text-[#111318]">Dr. Sarah
                                            Jennings</h4>
                                        <p class="text-sm text-[#636e88]">Chief of Surgery</p>
                                        <div
                                            class="mt-2 flex items-center gap-2 text-xs font-medium text-green-600">
                                            <span class="h-2 w-2 rounded-full bg-green-500"></span> Available Today
                                        </div>
                                    </div>
                                    <button
                                        class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-50 text-primary hover:bg-blue-100">
                                        <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                                    </button>
                                </div>
                                <!-- Doctor Card 2 -->
                                <div
                                    class="rounded-card flex items-start gap-4 border border-[#f0f2f4] p-4 transition hover:border-blue-100 hover:bg-blue-50/30">
                                    <div class="h-16 w-16 shrink-0 overflow-hidden rounded-full bg-gray-200">
                                        <img alt="Dr. Mark Doe profile picture" class="h-full w-full object-cover"
                                            width="64" height="64" loading="lazy" decoding="async"
                                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuCnzJnbZV96UXb3dPLDFYzdIbC_cFd0Fz6_8dmdKfKfJEjGyFKET81P_MoOyZlBznDgqHvrMTuCN0TKL3nxD1xVMZZMf-At8QgFWLsDe0jAOmD3v9_r2m53wQr0Y6uf6SKw7BOFMhBRCXAoEDCV4xmmBj0R2hx0ACigEIWWjk40Gt1et4q7E8JEnY9rLBZMYycN8BAkRaBTRzIVIOs3EOVhMah4JYxtrqlfN3F3IgsgIMkLkBeUn6F3rJLS2ikM4yfg3SUvMq_KyoyN" />
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-bold text-[#111318]">Dr. Mark Doe</h4>
                                        <p class="text-sm text-[#636e88]">Pediatrician</p>
                                        <div
                                            class="mt-2 flex items-center gap-2 text-xs font-medium text-[#636e88]">
                                            <span class="h-2 w-2 rounded-full bg-gray-300"></span> Next
                                            available: Tomorrow
                                        </div>
                                    </div>
                                    <button
                                        class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-50 text-primary hover:bg-blue-100">
                                        <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>
                    <!-- Right Column (Map & Info) -->
                    <div class="flex flex-col gap-6 lg:col-span-4">
                        <!-- Map Widget -->
                        <div class="rounded-card overflow-hidden bg-white shadow-sm">
                            <div class="relative h-64 w-full bg-gray-200">
                                <!-- Map Image Placeholder -->
                                <div class="h-full w-full bg-cover bg-center"
                                    data-alt="Map showing hospital location with surrounding streets"
                                    data-location="City Map View"
                                    style='background-image: url("https://placeholder.pics/svg/300");'></div>
                                <div class="absolute inset-0 flex items-center justify-center bg-black/10">
                                    <div class="flex flex-col items-center gap-2">
                                        <span
                                            class="material-symbols-outlined text-4xl text-red-600 drop-shadow-md">location_on</span>
                                    </div>
                                </div>
                                <div class="absolute bottom-4 left-4 right-4">
                                    <button
                                        class="rounded-card w-full bg-white py-3 text-sm font-bold text-[#111318] shadow-lg hover:bg-gray-50">
                                        Get Directions
                                    </button>
                                </div>
                            </div>
                            <div class="p-6">
                                <div class="mb-4 flex items-start gap-3">
                                    <span class="material-symbols-outlined mt-1 text-[#636e88]">near_me</span>
                                    <div>
                                        <p class="text-sm font-semibold text-[#111318]">15 min drive</p>
                                        <p class="text-xs text-[#636e88]">from your current location
                                        </p>
                                    </div>
                                </div>
                                <div class="space-y-3 border-t border-gray-100 pt-4">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-[#636e88]">Distance</span>
                                        <span class="text-sm font-medium text-[#111318]">4.2
                                            miles</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-[#636e88]">Phone</span>
                                        <span
                                            class="text-sm font-medium text-primary hover:underline cursor-pointer">(555)
                                            123-4567</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-[#636e88]">Email</span>
                                        <span
                                            class="text-sm font-medium text-primary hover:underline cursor-pointer">contact@stmarys.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Insurance Card -->
                        <div class="rounded-card bg-white p-6 shadow-sm">
                            <h3 class="mb-4 text-base font-bold text-[#111318]">Insurance Accepted</h3>
                            <div class="flex flex-wrap gap-2">
                                <span
                                    class="rounded-md border border-gray-200 px-2 py-1 text-xs font-medium text-gray-600">BlueCross</span>
                                <span
                                    class="rounded-md border border-gray-200 px-2 py-1 text-xs font-medium text-gray-600">Aetna</span>
                                <span
                                    class="rounded-md border border-gray-200 px-2 py-1 text-xs font-medium text-gray-600">Cigna</span>
                                <span
                                    class="rounded-md border border-gray-200 px-2 py-1 text-xs font-medium text-gray-600">UnitedHealth</span>
                                <span
                                    class="rounded-md border border-gray-200 px-2 py-1 text-xs font-medium text-gray-600">Medicare</span>
                                <span class="text-xs text-primary underline cursor-pointer self-center ml-1">+ 8
                                    more</span>
                            </div>
                        </div>
                        <!-- AI Recommended Donors -->
                        <div class="rounded-card bg-white p-6 shadow-sm">
                            <h3 class="flex items-center gap-2 mb-6 text-base font-bold text-[#111318]">
                                <span class="material-symbols-outlined text-primary">psychology</span>
                                AI Recommended Donors
                            </h3>
                            <div id="ai-matches" class="space-y-4">
                                <!-- Dynamic Content -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script type="module">
        import { auth, db, initAuthObserver } from '../assets/js/auth-service.js';
        import { getFullUserProfile, getDonorsByBloodGroup, searchDirectory, onSnapshot, doc } from '../assets/js/db-service.js';
        import { getAiMatchAnalysis } from '../assets/js/gemini-service.js';

        const aiContainer = document.getElementById('ai-matches');

        initAuthObserver(async (user) => {
            const navbar = document.querySelector('app-navbar');
            if (user && navbar && navbar.updateAuth) navbar.updateAuth(user);

            // Extract Hospital UID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const hospitalUid = urlParams.get('uid');

            if (hospitalUid) {
                listenHospitalDetails(hospitalUid);
            } else {
                // Fallback for demo if no UID provided
                fetchAiMatches('O-');
            }
        });

        function listenHospitalDetails(uid) {
            const hospitalRef = doc(db, 'users', uid);
            onSnapshot(hospitalRef, (snap) => {
                if (!snap.exists()) return;
                const profile = snap.data();

                // Update Hero Header
                document.querySelector('h1').textContent = profile.hospitalName || profile.displayName || "Hospital";
                document.title = `${profile.hospitalName || 'Hospital'} - LifeLink`;

                // Specific meta details in hero
                const heroMeta = document.querySelectorAll('.flex.flex-wrap.items-center.gap-4.text-sm div');
                if (heroMeta.length >= 2) {
                    heroMeta[1].innerHTML = `<span class="material-symbols-outlined text-[18px]">location_on</span> ${profile.address || profile.district || 'Location Private'}`;
                }

                // Update Blood Units if data exists
                if (profile.bloodAvailability) {
                    renderBloodUnits(profile.bloodAvailability);
                }

                // Update Specialties
                if (profile.specialties) {
                    renderSpecialties(profile.specialties);
                }

                // Fetch and render doctors from this hospital
                loadHospitalDoctors(profile.hospitalName);

                // AI Matches for their critical need
                fetchAiMatches(profile.criticalNeed || 'O-');
            });
        }

        function renderBloodUnits(units) {
            const container = document.querySelector('.grid.grid-cols-2.gap-4.sm\\:grid-cols-4');
            container.innerHTML = Object.entries(units).map(([type, count]) => {
                const isCritical = count <= 2;
                return `
                    <div class="rounded-card border ${isCritical ? 'border-red-100 bg-red-50' : 'border-gray-100 bg-gray-50'} p-4 text-center">
                        <div class="mb-1 text-2xl font-black ${isCritical ? 'text-emergency' : 'text-[#111318]'}">${type}</div>
                        <div class="text-sm font-medium ${isCritical ? 'text-emergency font-bold' : 'text-green-600'}">${count} Units</div>
                        <div class="mt-1 h-1.5 w-full rounded-full bg-gray-200">
                            <div class="h-1.5 rounded-full ${isCritical ? 'bg-emergency' : 'bg-green-500'}" style="width: ${Math.min(count * 10, 100)}%"></div>
                        </div>
                        ${isCritical ? '<span class="mt-1 block text-[10px] font-bold uppercase tracking-wider text-emergency">Critical</span>' : ''}
                    </div>
                `;
            }).join('');
        }

        function renderSpecialties(specialties) {
            const container = document.querySelector('.flex.flex-wrap.gap-3');
            if (container) {
                container.innerHTML = specialties.map(s => `
                    <span class="rounded-card inline-flex items-center gap-2 bg-blue-50 px-4 py-2 text-sm font-semibold text-primary">
                        <span class="material-symbols-outlined text-[18px]">medical_services</span> ${s}
                    </span>
                `).join('');
            }
        }

        async function loadHospitalDoctors(hospitalName) {
            const container = document.querySelector('.grid.gap-4.md\\:grid-cols-2');
            if (!container) return;

            try {
                const doctors = await searchDirectory(db, { name: hospitalName, role: 'doctor' });

                if (doctors.length === 0) {
                    container.innerHTML = `<p class="col-span-full text-slate-500 py-4 italic">No doctors listed for this hospital yet.</p>`;
                    return;
                }

                container.innerHTML = doctors.map(doc => `
                    <div class="rounded-card flex items-start gap-4 border border-[#f0f2f4] p-4 transition hover:border-blue-100 hover:bg-blue-50/30">
                        <div class="h-16 w-16 shrink-0 overflow-hidden rounded-full bg-gray-200">
                            <img src="${doc.photoURL || 'https://via.placeholder.com/150'}" alt="${doc.displayName}" class="h-full w-full object-cover" width="40" height="40" loading="lazy" decoding="async" />
                        </div>
                        <div class="flex-1">
                            <h4 class="text-base font-bold text-[#111318]">${doc.displayName}</h4>
                            <p class="text-sm text-[#636e88]">${doc.specialty || 'Medical Specialist'}</p>
                            <div class="mt-2 flex items-center gap-2 text-xs font-medium ${doc.availability ? 'text-green-600' : 'text-slate-500'}">
                                <span class="h-2 w-2 rounded-full ${doc.availability ? 'bg-green-500' : 'bg-slate-300'}"></span> 
                                ${doc.availability ? 'Available Today' : 'Unavailable'}
                            </div>
                        </div>
                        <a href="doctor_profile.html?uid=${doc.uid}" class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-50 text-primary hover:bg-blue-100">
                            <span class="material-symbols-outlined text-[20px]">chevron_right</span>
                        </a>
                    </div>
                `).join('');
            } catch (err) {
                console.error("Error loading doctors:", err);
            }
        }

        async function fetchAiMatches(bloodGroup) {
            aiContainer.innerHTML = `<div class="p-8 text-center"><div class="animate-spin w-8 h-8 border-4 border-primary/20 border-t-primary rounded-full mx-auto mb-4"></div><p class="text-sm text-slate-500">AI is finding potential donors...</p></div>`;

            try {
                const donors = await getDonorsByBloodGroup(db, bloodGroup);
                if (donors.length === 0) {
                    aiContainer.innerHTML = `<div class="p-8 text-center text-slate-500">No available ${bloodGroup} donors found nearby.</div>`;
                    return;
                }

                // Analyze with AI
                const analysis = await getAiMatchAnalysis({ bloodGroup, urgency: 'high' }, donors);
                const aiSummary = analysis?.error
                    ? 'AI analysis unavailable right now. Showing nearby compatible donors.'
                    : (analysis.compatibility || analysis.advice || 'AI analysis completed.');

                aiContainer.innerHTML = `
                    <div class="p-4 bg-primary/5 rounded-xl border border-primary/10 mb-6">
                        <div class="flex items-center gap-2 mb-2 text-primary font-bold">
                            <span class="material-symbols-outlined">psychology</span>
                            <span>AI Strategy</span>
                        </div>
                        <p class="text-xs text-slate-600 italic">${aiSummary}</p>
                    </div>
                    <div class="space-y-4">
                        ${donors.slice(0, 3).map(donor => `
                            <div class="flex items-center gap-4 p-4 rounded-xl border border-slate-100 hover:bg-slate-50 transition-all">
                                <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-primary">${donor.bloodGroup}</div>
                                <div class="flex-1">
                                    <h5 class="font-bold text-sm text-slate-900">${donor.displayName}</h5>
                                    <p class="text-[10px] text-slate-500">${donor.district || 'Unknown location'}</p>
                                </div>
                                <a href="tel:${donor.phone || ''}" class="p-2 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600 transition-all">
                                    <span class="material-symbols-outlined text-sm">call</span>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;

            } catch (err) {
                console.error(err);
                aiContainer.innerHTML = `<div class="p-8 text-center text-emergency text-sm">AI matching service unavailable.</div>`;
            }
        }
    </script></body>

</html>