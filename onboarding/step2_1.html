<!DOCTYPE html>
<html class="theme-preload" lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Donor Profile - Step 2</title>
  <script src="../assets/js/theme-manager.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Hind+Siliguri:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">

  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700&amp;display=swap"
    rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <!-- Custom Tailwind Config -->
  <script src="../assets/js/config.js"></script>

  <!-- Custom Components -->
  <script src="../assets/js/components.js"></script>

  <!-- Custom CSS -->
  <link href="../assets/css/styles.css" rel="stylesheet" />
  <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg" />
</head>

<body
  class="bg-aurora text-slate-800 dark:text-slate-100 antialiased selection:bg-primary/30 selection:text-primary-dark transition-colors duration-500 overflow-x-hidden">

  <!-- Navigation Bar -->
  <app-navbar></app-navbar>

  <main class="relative z-10 pt-32 pb-20 min-h-screen flex items-center">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 w-full">

      <!-- Progress Bar -->
      <div class="mb-12">
        <div class="flex items-center justify-between mb-4">
          <span class="text-sm font-semibold text-primary" data-i18n="onboarding.step2.of">Step 2 of 4</span>
          <span class="text-sm text-slate-500" data-i18n="onboarding.step2.donor.title">Donor Profile</span>
        </div>
        <div class="h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
          <div class="h-full bg-brand-gradient w-2/4 transition-all duration-500"></div>
        </div>
      </div>

      <!-- Main Card -->
      <div
        class="bg-white dark:bg-surface-dark rounded-[2rem] shadow-2xl border border-slate-200 dark:border-slate-700 p-8 md:p-12">

        <!-- Header -->
        <div class="mb-10">
          <div
            class="w-16 h-16 bg-emerald-100 dark:bg-emerald-900/30 text-primary rounded-2xl flex items-center justify-center mb-6">
            <span class="material-symbols-outlined text-4xl">volunteer_activism</span>
          </div>
          <h1 class="text-3xl font-black text-slate-900 dark:text-white mb-3" data-i18n="onboarding.step2.donor.header">
            Donor Information
          </h1>
          <p class="text-slate-600 dark:text-slate-400 text-lg" data-i18n="onboarding.step2.donor.subtitle">
            Tell us about yourself to help save lives
          </p>
        </div>

        <!-- Form -->
        <form id="donorForm" class="space-y-6">

          <!-- Personal Information -->
          <div class="space-y-6">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">person</span>
              <span data-i18n="onboarding.section.personal">Personal Details</span>
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Date of Birth -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.dob">
                  Date of Birth *
                </label>
                <input type="date" name="dob" required
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
              </div>

              <!-- Gender -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.gender">
                  Gender *
                </label>
                <select name="gender" required
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                  <option value="" data-i18n="onboarding.option.select_gender">Select gender</option>
                  <option value="male" data-i18n="onboarding.option.male">Male</option>
                  <option value="female" data-i18n="onboarding.option.female">Female</option>
                  <option value="other" data-i18n="onboarding.option.other">Other</option>
                </select>
              </div>

              <!-- Blood Group -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.blood_group">
                  Blood Group *
                </label>
                <select name="bloodGroup" required
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                  <option value="" data-i18n="onboarding.option.select_blood">Select blood group</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Contact Information -->
          <div class="space-y-6 pt-6 border-t border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">contact_phone</span>
              <span data-i18n="onboarding.section.contact">Contact Information</span>
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Email -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.email">
                  Email Address *
                </label>
                <input type="email" name="email" required
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                  placeholder="your@email.com" data-placeholder-i18n="onboarding.placeholder.email">
              </div>

              <!-- Phone -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.phone">
                  Phone Number *
                </label>
                <input type="tel" name="phone" required
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                  placeholder="+880 1234-567890" data-placeholder-i18n="onboarding.placeholder.phone">
              </div>
            </div>
          </div>

          <!-- Location -->
          <div class="space-y-6 pt-6 border-t border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">location_on</span>
              <span data-i18n="onboarding.section.location">Location</span>
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Division -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.division">
                  Division *
                </label>
                <select name="division" required data-division-select
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                </select>
              </div>

              <!-- District -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.district">
                  District *
                </label>
                <select name="district" required data-district-select
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                </select>
              </div>

              <!-- Full Address -->
              <div class="md:col-span-2">
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.address">
                  Full Address
                </label>
                <textarea name="address" rows="3"
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                  placeholder="House/Flat, Road, Area, Thana"
                  data-placeholder-i18n="onboarding.placeholder.address"></textarea>
              </div>
            </div>
          </div>

          <!-- Medical Eligibility -->
          <div class="space-y-6 pt-6 border-t border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">clinical_notes</span>
              <span data-i18n="onboarding.section.medical">Medical Eligibility</span>
            </h3>

            <div class="space-y-4">
              <!-- Weight -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.weight">
                  Weight (kg) *
                </label>
                <input type="number" name="weight" required min="45"
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all"
                  placeholder="Minimum 45 kg required" data-placeholder-i18n="onboarding.placeholder.weight">
                <p class="text-xs text-slate-500 mt-1" data-i18n="onboarding.info.weight">Donors must weigh at least 45
                  kg</p>
              </div>

              <!-- Medical Conditions -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3"
                  data-i18n="onboarding.label.conditions_q">
                  Do you have any of the following conditions? *
                </label>
                <div class="space-y-3">
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" name="conditions" value="none"
                      class="mt-1 w-5 h-5 rounded border-slate-300 text-primary focus:ring-primary">
                    <span class="text-sm text-slate-700 dark:text-slate-300" data-i18n="onboarding.condition.none">None
                      of the below</span>
                  </label>
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" name="conditions" value="hiv"
                      class="mt-1 w-5 h-5 rounded border-slate-300 text-emergency focus:ring-emergency">
                    <span class="text-sm text-slate-700 dark:text-slate-300"
                      data-i18n="onboarding.condition.hiv">HIV/AIDS, Hepatitis B/C</span>
                  </label>
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" name="conditions" value="diabetes"
                      class="mt-1 w-5 h-5 rounded border-slate-300 text-emergency focus:ring-emergency">
                    <span class="text-sm text-slate-700 dark:text-slate-300"
                      data-i18n="onboarding.condition.diabetes">Diabetes, Heart disease</span>
                  </label>
                  <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" name="conditions" value="cancer"
                      class="mt-1 w-5 h-5 rounded border-slate-300 text-emergency focus:ring-emergency">
                    <span class="text-sm text-slate-700 dark:text-slate-300"
                      data-i18n="onboarding.condition.cancer">Cancer or undergoing chemotherapy</span>
                  </label>
                </div>
              </div>

              <!-- Last Donation -->
              <div>
                <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2"
                  data-i18n="onboarding.label.last_donation">
                  Last Blood Donation Date
                </label>
                <input type="date" name="lastDonation"
                  class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all">
                <p class="text-xs text-slate-500 mt-1" data-i18n="onboarding.info.last_donation">Leave blank if
                  first-time donor</p>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex flex-col sm:flex-row gap-4 pt-8">
            <a href="step1.html"
              class="flex-1 px-6 py-4 rounded-xl border-2 border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 font-bold text-center hover:bg-slate-50 dark:hover:bg-slate-800 transition-all"
              data-i18n="onboarding.btn.back_step">
              <span class="material-symbols-outlined inline-block mr-2">arrow_back</span>
              Back
            </a>
            <button type="submit"
              class="flex-1 bg-brand-gradient text-white px-6 py-4 rounded-xl font-bold shadow-lg shadow-primary/20 hover:scale-105 transition-all duration-300 flex items-center justify-center gap-2">
              <span data-i18n="onboarding.btn.continue_verify">Continue to Verification</span>
              <span class="material-symbols-outlined">arrow_forward</span>
            </button>
          </div>
        </form>

      </div>

    </div>
  </main>
  <app-footer></app-footer>

  <!-- Scripts -->
  <script src="../assets/js/localization.js"></script>
  <script src="../assets/js/districts.js"></script>
  <script src="../assets/js/divisions.js"></script>
  <script src="../assets/js/animations.js"></script>
  <script src="../assets/js/main.js"></script>

  <script type="module">
    import { validateField, showFieldError, clearFieldError, setupRealtimeValidation } from '../assets/js/validation.js';
    import { handleAsyncOperation, showErrorNotification, showSuccessNotification } from '../assets/js/error-handler.js';
    import { saveUserProfile, getFullUserProfile } from '../assets/js/db-service.js';
    import { auth, db } from '../assets/js/auth-service.js';

    // Get form inputs
    const form = document.getElementById('donorForm');
    const dobInput = form.querySelector('[name="dob"]');
    const weightInput = form.querySelector('[name="weight"]');
    const emailInput = form.querySelector('[name="email"]');
    const phoneInput = form.querySelector('[name="phone"]');
    const bloodGroupInput = form.querySelector('[name="bloodGroup"]');

    // Setup validation
    setupRealtimeValidation(dobInput, 'dob');
    setupRealtimeValidation(weightInput, 'weight');
    setupRealtimeValidation(emailInput, 'email');
    setupRealtimeValidation(phoneInput, 'phone');
    setupRealtimeValidation(bloodGroupInput, 'bloodGroup');

    // Form submission
    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      // Clear errors
      [dobInput, weightInput, emailInput, phoneInput, bloodGroupInput].forEach(clearFieldError);

      // Get form data
      const formData = new FormData(this);
      const donorData = Object.fromEntries(formData);

      // Validate
      const dobError = validateField('dob', donorData.dob);
      const weightError = validateField('weight', donorData.weight);
      const emailError = validateField('email', donorData.email);
      const phoneError = validateField('phone', donorData.phone);
      const bloodError = validateField('bloodGroup', donorData.bloodGroup);

      let hasError = false;
      if (dobError) { showFieldError(dobInput, dobError); hasError = true; }
      if (weightError) { showFieldError(weightInput, weightError); hasError = true; }
      if (emailError) { showFieldError(emailInput, emailError); hasError = true; }
      if (phoneError) { showFieldError(phoneInput, phoneError); hasError = true; }
      if (bloodError) { showFieldError(bloodGroupInput, bloodError); hasError = true; }

      if (hasError) return;

      // Get conditions
      const conditions = Array.from(document.querySelectorAll('input[name="conditions"]:checked'))
        .map(cb => cb.value);

      // Check if user is authenticated
      const user = auth.currentUser;
      if (!user) {
        showErrorNotification('Please login first');
        window.location.href = '../auth/login.html';
        return;
      }

      // Save to Firebase
      const result = await handleAsyncOperation(
        async () => {
          await saveUserProfile(db, user, 'donor', {
            dob: donorData.dob,
            gender: donorData.gender,
            bloodGroup: donorData.bloodGroup,
            email: donorData.email,
            phone: donorData.phone,
            division: donorData.division,
            district: donorData.district,
            address: donorData.address,
            weight: parseFloat(donorData.weight),
            conditions: conditions,
            lastDonation: donorData.lastDonation || null,
            onboardingStep: 2
          });
        },
        form.querySelector('button[type="submit"]'),
        'Saving...'
      );

      if (result.success) {
        showSuccessNotification('Profile saved successfully');
        window.location.href = 'step3.html';
      }
    });

    // Prevent selecting multiple conditions if "none" is selected
    const checkboxes = document.querySelectorAll('input[name="conditions"]');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function () {
        if (this.value === 'none' && this.checked) {
          checkboxes.forEach(cb => {
            if (cb !== this) cb.checked = false;
          });
        } else if (this.value !== 'none' && this.checked) {
          checkboxes.forEach(cb => {
            if (cb.value === 'none') cb.checked = false;
          });
        }
      });
    });

    // Load existing data if any
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const profile = await getFullUserProfile(db, user.uid);
        if (profile && profile.onboardingStep >= 2) {
          // Pre-fill form
          if (profile.dob) dobInput.value = profile.dob;
          if (profile.gender) form.querySelector('[name="gender"]').value = profile.gender;
          if (profile.bloodGroup) bloodGroupInput.value = profile.bloodGroup;
          if (profile.email) emailInput.value = profile.email;
          if (profile.phone) phoneInput.value = profile.phone;
          if (profile.division) form.querySelector('[name="division"]').value = profile.division;
          if (profile.district) form.querySelector('[name="district"]').value = profile.district;
          if (profile.address) form.querySelector('[name="address"]').value = profile.address;
          if (profile.weight) weightInput.value = profile.weight;
          if (profile.lastDonation) form.querySelector('[name="lastDonation"]').value = profile.lastDonation;
        }
      }
    });
  </script>
</body>

</html>